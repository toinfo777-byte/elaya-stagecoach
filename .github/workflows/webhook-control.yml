name: Webhook control

on:
  workflow_dispatch:
    inputs:
      action:
        description: "Action: set | delete | get"
        required: true
        default: "get"
        type: choice
        options: [set, delete, get]
      webhook_url:
        description: "Webhook URL (only for set)"
        required: false
        default: "https://elaya-stagecoach-web.onrender.com/tg/webhook"
        type: string

jobs:
  ctl:
    runs-on: ubuntu-latest
    steps:
      - name: Show action
        run: echo "ACTION=${{ inputs.action }} URL=${{ inputs.webhook_url }}"

      - name: Set webhook
        if: ${{ inputs.action == 'set' }}
        run: |
          curl -sS "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/setWebhook" \
            -d "url=${{ inputs.webhook_url }}" \
            -d "allowed_updates[]=message" \
            -d "max_connections=40"
          echo
          curl -sS "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/getWebhookInfo"

      - name: Delete webhook
        if: ${{ inputs.action == 'delete' }}
        run: |
          curl -sS "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/deleteWebhook" \
            -d "drop_pending_updates=true"
          echo
          curl -sS "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/getWebhookInfo"

      - name: Get webhook info
        if: ${{ inputs.action == 'get' }}
        run: |
          curl -sS "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/getWebhookInfo"
