name: Webhook control

on:
  workflow_dispatch:
    inputs:
      action:
        description: "get | set | delete"
        required: true
        default: get
      url:
        description: "Webhook URL (для set)"
        required: false
      secret:
        description: "Webhook secret (опц.)"
        required: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure gh
        uses: cli/gh-action@v2
      - name: Act
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TG_TOKEN:  ${{ secrets.TELEGRAM_TOKEN }}
        run: |
          case "${{ github.event.inputs.action }}" in
            get)
              gh api -X POST "https://api.telegram.org/bot${TG_TOKEN}/getWebhookInfo" -H "Content-Type: application/json" -f '{}' || true
              ;;
            set)
              if [ -z "${{ github.event.inputs.url }}" ]; then
                echo "url is required for action=set"; exit 1
              fi
              gh api -X POST "https://api.telegram.org/bot${TG_TOKEN}/setWebhook" \
                -F url="${{ github.event.inputs.url }}" \
                -F secret_token="${{ github.event.inputs.secret }}"
              ;;
            delete)
              gh api -X POST "https://api.telegram.org/bot${TG_TOKEN}/deleteWebhook"
              ;;
            *)
              echo "unknown action"; exit 1
              ;;
          esac
