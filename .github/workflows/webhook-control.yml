name: Webhook control

on:
  workflow_dispatch:
    inputs:
      action:
        description: "get | set | delete"
        required: true
        default: get
      url:
        description: "Webhook URL (для set)"
        required: false
      secret:
        description: "Webhook secret (опц.)"
        required: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Telegram webhook control
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          ACTION: ${{ github.event.inputs.action }}
          URL: ${{ github.event.inputs.url }}
          SECRET: ${{ github.event.inputs.secret }}
        run: |
          set -e
          API="https://api.telegram.org/bot${BOT_TOKEN}"
          echo "→ Action: $ACTION"
          
          if [ "$ACTION" = "get" ]; then
            curl -s "$API/getWebhookInfo" | jq .
          elif [ "$ACTION" = "set" ]; then
            curl -s -X POST "$API/setWebhook" \
              -d "url=${URL}" \
              ${SECRET:+-d "secret_token=${SECRET}"} | jq .
          elif [ "$ACTION" = "delete" ]; then
            curl -s -X POST "$API/deleteWebhook" | jq .
          else
            echo "❌ Unknown action: $ACTION"
            exit 1
          fi
