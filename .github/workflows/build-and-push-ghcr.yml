name: Build & Push Docker image to GHCR

on:
  push:
    branches: [ develop ]      # –∞–≤—Ç–æ—Å–±–æ—Ä–∫–∞/–¥–µ–ø–ª–æ–π –ø—Ä–∏ –∫–æ–º–º–∏—Ç–∞—Ö –≤ develop
  workflow_dispatch:            # –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–∑ Actions

# —á—Ç–æ–±—ã –Ω–µ –ø–ª–æ–¥–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –¥–µ–ø–ª–æ–µ–≤
concurrency:
  group: ghcr-deploy-develop
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write          # –ø—É—à–∏—Ç—å –≤ GHCR
      id-token: write

    env:
      IMAGE: ghcr.io/${{ github.repository }}/elaya-stagecoach
      TAG: develop             # —Ç–æ—Ç –∂–µ —Ç–µ–≥, —á—Ç–æ —É–∫–∞–∑–∞–Ω –≤ Render -> Settings -> Image URL

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–µ—à –±–∏–ª–¥–∞ ‚Äî —É—Å–∫–æ—Ä—è–µ—Ç —Å–±–æ—Ä–∫—É
      - name: Build & Push (develop + short-sha)
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64
          tags: |
            ${{ env.IMAGE }}:${{ env.TAG }}
            ${{ env.IMAGE }}:${{ github.sha }}
          cache-from: type=registry,ref=${{ env.IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.IMAGE }}:buildcache,mode=max

      # üöÄ –¢—Ä–∏–≥–≥–µ—Ä–∏–º –¥–µ–ø–ª–æ–π —Å–µ—Ä–≤–∏—Å–∞ –≤ Render
      - name: Trigger Render deploy (develop)
        run: |
          curl -fsSL -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
