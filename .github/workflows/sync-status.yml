name: Sync Elaya Status

on:
  workflow_dispatch:
    inputs:
      block:
        description: "Имя блока (например: 'Build' или 'Блок 3 — Управляемость')"
        required: false
      content:
        description: "Markdown-патч/вставка"
        required: false
  repository_dispatch:
    types: [status_sync]
  push:
    branches: [develop]
    paths:
      - "docs/**.md"

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install markdown-it-py==3.0.0

      - name: Apply update via tools/sync_status.py
        env:
          GH_EVENT_PATH: ${{ github.event_path }}
          SYNC_BLOCK: ${{ github.event.inputs.block }}
          SYNC_CONTENT: ${{ github.event.inputs.content }}
          # пробрасываем метки билда (если пришли через repository_dispatch/client_payload → env не нужен)
          BUILD_MARK: ${{ github.event.client_payload.BUILD_MARK }}
          SHORT_SHA:  ${{ github.event.client_payload.SHORT_SHA }}
          IMAGE_TAG:  ${{ github.event.client_payload.IMAGE_TAG }}
          ENV:        ${{ github.event.client_payload.ENV }}
        run: python tools/sync_status.py

      - name: Commit changes (to develop)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "sync: update Elaya status [skip ci]"
          branch: develop
          file_pattern: docs/*.md tools/sync_status.log

      - name: Notify Telegram (success)
        if: ${{ success() }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CHAT:  ${{ secrets.ADMIN_ALERT_CHAT_ID }}
          RUN_URL:  ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          BRANCH:   ${{ github.ref_name }}
          SHA:      ${{ github.sha }}
          FILE:     docs/Elaya_Current_Status_Q4_2025.md
        run: |
          SHORT_SHA="${SHA:0:7}"
          TEXT="✅ Статус синхронизирован
Repo: ${GITHUB_REPOSITORY}
Branch: ${BRANCH}
Commit: ${SHORT_SHA}
Файл: ${FILE}
CI: ${RUN_URL}"
          curl -sS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" \
            -d text="$TEXT" \
            -d disable_web_page_preview=true >/dev/null
