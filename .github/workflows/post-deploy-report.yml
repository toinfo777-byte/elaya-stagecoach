name: Post-deploy status report

on:
  workflow_dispatch:
  repository_dispatch:
    types: [status_report]

jobs:
  postdeploy:
    runs-on: ubuntu-latest
    steps:
      - name: Send post-deploy status to Telegram
        env:
          TG_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID:  ${{ secrets.TG_STATUS_CHAT_ID }}
          REPO:     ${{ github.repository }}
          RUN_ID:   ${{ github.run_id }}
          SHA:      ${{ github.sha }}
        run: |
          SHORT=$(echo "$SHA" | cut -c1-7)
          TEXT="ðŸš€ Post-deploy Â· ${REPO} Â· ${SHORT}\nhttps://github.com/${REPO}/actions/runs/${RUN_ID}"
          curl -sS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d parse_mode="Markdown" \
            --data-urlencode text="$TEXT" >/dev/null
