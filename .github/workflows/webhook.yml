name: Webhook control

on:
  workflow_dispatch:
    inputs:
      action:
        description: "set / delete / info"
        required: true
        default: "set"
        type: choice
        options: [set, delete, info]
      env:
        description: "Environment label (only for info)"
        required: false
        default: "staging"
        type: string

jobs:
  webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Compute WEBHOOK_URL
        id: compute
        shell: bash
        env:
          RENDER_BASE: ${{ secrets.RENDER_WEB_URL_BASE }}   # e.g. https://elaya-stagecoach-web.onrender.com
        run: |
          PATH_SUFFIX="/tg/webhook"
          if [[ -z "${RENDER_BASE}" ]]; then
            echo "RENDER_WEB_URL_BASE secret is empty"; exit 1
          fi
          echo "url=${RENDER_BASE}${PATH_SUFFIX}" | tee url.txt
          echo "WEBHOOK_URL=${RENDER_BASE}${PATH_SUFFIX}" >> $GITHUB_OUTPUT

      - name: Set webhook
        if: ${{ inputs.action == 'set' }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          WEBHOOK_URL: ${{ steps.compute.outputs.WEBHOOK_URL }}
          ALLOWED_UPDATES: '["message","edited_message","channel_post","edited_channel_post","callback_query"]'
        run: ./scripts/set_webhook.sh

      - name: Delete webhook
        if: ${{ inputs.action == 'delete' }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        run: ./scripts/delete_webhook.sh

      - name: Get webhook info
        if: ${{ inputs.action == 'info' }}
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        run: ./scripts/get_webhook_info.sh

      - name: Show healthz (debug)
        if: ${{ inputs.action == 'set' || inputs.action == 'info' }}
        run: |
          URL="${{ steps.compute.outputs.WEBHOOK_URL }}"
          BASE="${URL%/tg/webhook}"
          echo "Checking ${BASE}/healthz ..."
          curl -sS "${BASE}/healthz" | jq .
