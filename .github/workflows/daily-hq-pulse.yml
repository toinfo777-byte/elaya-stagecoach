name: Daily HQ Pulse

on:
  schedule:
    # 23:59 Europe/Moscow = 20:59 UTC
    - cron: "59 20 * * *"
  workflow_dispatch: {}

jobs:
  build-pulse:
    runs-on: ubuntu-latest
    env:
      TZ: Europe/Moscow
      WEB_URL: ${{ secrets.STAGECOACH_WEB_URL }}
      TRAINER_URL: ${{ secrets.TRAINER_WEB_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Collect health
        id: ping
        run: |
          set -e
          # ÐŸÐ¸Ð½Ð³Ð¸ Ð±ÐµÐ· Ð¿Ð°Ð´ÐµÐ½Ð¸Ñ job, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ ÑÐµÑ€Ð²Ð¸Ñ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
          web_code=$(curl -s -o /dev/null -w "%{http_code}" "${WEB_URL}/healthz" || echo "000")
          trn_code=$(curl -s -o /dev/null -w "%{http_code}" "${TRAINER_URL}/healthz" || echo "000")

          # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ¾Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼Ñ‹Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹
          web_status=$([ "$web_code" = "200" ] && echo "ðŸŸ¢ 200 OK" || echo "ðŸ”´ ${web_code}")
          trn_status=$([ "$trn_code" = "200" ] && echo "ðŸŸ¢ 200 OK" || echo "ðŸ”´ ${trn_code}")

          echo "web_status=$web_status"   >> $GITHUB_OUTPUT
          echo "trn_status=$trn_status"   >> $GITHUB_OUTPUT
          echo "web_code=$web_code"       >> $GITHUB_OUTPUT
          echo "trn_code=$trn_code"       >> $GITHUB_OUTPUT
          echo "today=$(date +%F)"        >> $GITHUB_OUTPUT
          echo "now_hm=$(date +'%H:%M')"  >> $GITHUB_OUTPUT

      - name: Generate markdown
        id: md
        run: |
          set -e
          DATE="${{ steps.ping.outputs.today }}"
          NOW="${{ steps.ping.outputs.now_hm }}"
          WEB="${{ steps.ping.outputs.web_status }}"
          TRN="${{ steps.ping.outputs.trn_status }}"

          mkdir -p docs/hq/pulse

          cat > "docs/hq/pulse/${DATE}.md" <<EOF
# ðŸ©µ HQ Pulse â€” ${DATE}
**Ð¡Ð±Ð¾Ñ€ÐºÐ°:** staging Â· scheduled  
**Ð’Ñ€ÐµÐ¼Ñ (MSK):** ${NOW}

## ðŸ§­ DevOps-cycle
**Status:** $( [ "${WEB#* }" = "200" ] && [ "${TRN#* }" = "200" ] && echo "stable âœ…" || echo "degraded âš ï¸" )
**Key event:** nightly heartbeat

## ðŸ¤– Bots Status
| Ð£Ð·ÐµÐ» | /healthz |
|:-----|:---------|
| Web (Stagecoach) | ${WEB} |
| Trainer Bot      | ${TRN} |

## Ð—Ð°Ð¼ÐµÑ‚ÐºÐ¸
- ÐžÑ‚Ñ‡Ñ‘Ñ‚ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ GitHub Actions Ð¿Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸ÑŽ (23:59 MSK).
- Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ â€” Ð¿ÑƒÐ±Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ /healthz Render-ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð².

_Ð­Ð»Ð°Ð¹Ñ Ð´Ñ‹ÑˆÐ¸Ñ‚._
EOF

          # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Â«Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹Â» ÑÐ²Ð¾Ð´Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
          cp "docs/hq/pulse/${DATE}.md" docs/hq/pulse/Elaya_Current_Status_Q4_2025.md

      - name: Commit & push
        run: |
          git config user.name  "elaya-hq-bot"
          git config user.email "actions@users.noreply.github.com"
          git add docs/hq/pulse/
          git commit -m "ðŸ©µ HQ Pulse: nightly snapshot ($(date +%F))" || echo "Nothing to commit"
          git push
