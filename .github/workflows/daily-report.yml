name: Daily status report

on:
  schedule:
    # 06:00 UTC = 09:00 MSK
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: write    # –ø—É—à–∏–º md –≤ docs/
  packages: read

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build markdown
        run: |
          mkdir -p docs/elaya_status
          TS="$(date -u +'%Y-%m-%d %H:%M:%SZ')"
          DATE="$(date -u +'%Y%m%d')"
          FILE="docs/elaya_status/Elaya_Status_${DATE}.md"

          cat > "${FILE}" <<'MD'
          # –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç
          - Time (UTC): ${TS}
          - Branch: $GITHUB_REF_NAME
          - Commit: $GITHUB_SHA
          - Runner: $GITHUB_RUN_ID

          ## –ü—É–ª—å—Å
          - ENV: develop
          - Source: GitHub Actions
          - Notes: –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è.
          MD

          # –ü–æ–¥—Å—Ç–∞–≤–∏–º —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
          sed -i "s|\${TS}|${TS}|g" "${FILE}"

          echo "OUT_FILE=${FILE}" >> $GITHUB_ENV

      - name: Commit & push
        run: |
          git config user.name "elaya-bot"
          git config user.email "actions@users.noreply.github.com"
          git add "${{ env.OUT_FILE }}"
          git commit -m "Daily: $(basename "${{ env.OUT_FILE }}")" || echo "Nothing to commit"
          git push

      - name: Send Telegram notify
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID:   ${{ secrets.TG_REPORT_CHAT_ID }}
        # –í if –ù–ï –æ–±—Ä–∞—â–∞–µ–º—Å—è –∫ secrets –Ω–∞–ø—Ä—è–º—É—é ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º env
        if: ${{ env.TG_BOT_TOKEN != '' && env.TG_CHAT_ID != '' }}
        run: |
          FILE_URL="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/${{ env.OUT_FILE }}"
          TEXT=$(cat <<EOF
üßæ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç
‚Ä¢ ENV: develop
‚Ä¢ Branch: ${GITHUB_REF_NAME}
‚Ä¢ SHA: ${GITHUB_SHA::7}
‚Ä¢ File: ${FILE_URL}
EOF
)
          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TG_CHAT_ID}" \
            --data-urlencode "text=${TEXT}" \
            -d "disable_web_page_preview=true"
