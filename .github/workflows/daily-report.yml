name: Daily status report

on:
  workflow_dispatch:
  schedule:
    # 06:00 UTC = 09:00 MSK
    - cron: "0 6 * * *"

permissions:
  contents: write
  packages: read

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Build markdown
        run: |
          mkdir -p docs/elaya_status
          TS="$(date -u +'%Y-%m-%d %H:%M:%SZ')"
          DATE="$(date -u +'%Y%m%d')"
          FILE="docs/elaya_status/Elaya_Status_${DATE}.md"
          cat > "${FILE}" <<'MD'
          # Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚
          - Time (UTC): ${TS}
          - Branch: $GITHUB_REF_NAME
          - Commit: $GITHUB_SHA
          - Runner: $GITHUB_RUN_ID

          ## ÐŸÑƒÐ»ÑŒÑ
          - ENV: develop
          - Source: GitHub Actions
          - Notes: ÐÐ²Ñ‚Ð¾Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ.
          MD
          sed -i "s|\${TS}|${TS}|g" "${FILE}"
          echo "OUT_FILE=${FILE}" >> $GITHUB_ENV

      - name: Commit & push
        run: |
          git config user.name "elaya-bot"
          git config user.email "actions@users.noreply.github.com"
          git add "${{ env.OUT_FILE }}"
          git commit -m "Daily: $(basename "${{ env.OUT_FILE }}")" || echo "Nothing to commit"
          git push

      - name: Send Telegram notify
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_REPORT_CHAT_ID }}
        run: |
          if [ -z "$TG_BOT_TOKEN" ] || [ -z "$TG_CHAT_ID" ]; then
            echo "No TG secrets, skip"
            exit 0
          fi
          FILE_URL="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/main/${{ env.OUT_FILE }}"
          TEXT=$(cat <<EOF
ðŸ§¾ Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚
â€¢ ENV: develop
â€¢ Branch: ${GITHUB_REF_NAME}
â€¢ SHA: ${GITHUB_SHA::7}
â€¢ File: ${FILE_URL}
EOF
)
          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TG_CHAT_ID}" \
            --data-urlencode "text=${TEXT}" \
            -d "disable_web_page_preview=true" \
            -d "parse_mode=HTML"
