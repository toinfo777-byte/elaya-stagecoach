name: Daily status report

on:
  schedule:
    # 06:00 UTC = 09:00 MSK
    - cron: "0 6 * * *"
  workflow_dispatch: {}            # –∑–∞–ø—É—Å–∫ –∏–∑ UI (Actions ‚Üí Run workflow)
  repository_dispatch:             # –∑–∞–ø–∞—Å–Ω–æ–π —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ API
    types: [daily-report]

permissions:
  contents: write
  packages: read

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install -U pip
          pip install markdown-it-py==3.0.0 pyyaml

      - name: Build markdown
        env:
          TZ: Europe/Moscow
        run: |
          mkdir -p docs/elaya_status
          # —Ç–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç—á—ë—Ç–∞
          python tools/daily_report.py
          # –≤—ã—á–∏—Å–ª–∏–º –∏–º—è –∏—Ç–æ–≥–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–∏–º –≤ ENV
          TODAY="$(date -u +'%Y-%m-%d')"
          echo "OUT=docs/elaya_status/Elaya_Status_${TODAY}.md" >> $GITHUB_ENV
          ls -la docs/elaya_status || true

      - name: Commit md to develop
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(report): daily Elaya status [skip ci]"
          branch: develop
          file_pattern: docs/elaya_status/*.md

      # (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) PDF
      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Build PDF
        shell: bash
        run: |
          TODAY="$(date -u +'%Y-%m-%d')"
          IN="docs/elaya_status/Elaya_Status_${TODAY}.md"
          OUT="docs/elaya_status/Elaya_Status_${TODAY}.pdf"
          [ -f "$IN" ] && pandoc "$IN" -o "$OUT" || exit 0

      - name: Upload PDF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Daily_Status_PDF
          path: docs/elaya_status/*.pdf

      - name: Notify Telegram
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_REPORT_CHAT_ID }}
        run: |
          if [ -z "$TG_BOT_TOKEN" ] || [ -z "$TG_CHAT_ID" ]; then
            echo "No TG secrets, skip"
            exit 0
          fi
          FILE_URL="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/develop/${{ env.OUT }}"
          TEXT=$(cat <<EOF
üßæ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç
‚Ä¢ ENV: develop
‚Ä¢ Branch: develop
‚Ä¢ SHA: ${GITHUB_SHA::7}
‚Ä¢ File: ${FILE_URL}
EOF
)
          curl -sS -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
            -d "chat_id=${TG_CHAT_ID}" \
            --data-urlencode "text=${TEXT}" \
            -d "disable_web_page_preview=true"
