name: Daily status report

on:
  schedule:
    # 09:00 MSK = 06:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: daily-report
  cancel-in-progress: false

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install markdown-it-py==3.0.0

      - name: Generate daily markdown
        env:
          # опционально, если нужен доступ к токенам (не обязательно)
          # TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          # ADMIN_ALERT_CHAT_ID: ${{ secrets.ADMIN_ALERT_CHAT_ID }}
          TZ: Europe/Moscow
        run: |
          python tools/daily_report.py  # файл уже есть у нас
          ls -la docs/elaya_status || true

      - name: Commit report to develop
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(report): daily Elaya status [skip ci]"
          branch: develop
          file_pattern: docs/elaya_status/*.md

      - name: Notify Telegram (success)
        if: ${{ success() }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CHAT:  ${{ secrets.ADMIN_ALERT_CHAT_ID }}
        run: |
          TODAY="$(date -u +'%Y-%m-%d')"
          FILE="docs/elaya_status/Elaya_Status_${TODAY}.md"
          TEXT="🗓 Ежедневный отчёт собран\nФайл: ${FILE}\nВетка: develop"
          curl -sS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" -d text="$TEXT" -d disable_web_page_preview=true >/dev/null

      - name: Notify Telegram (failure)
        if: ${{ failure() }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CHAT:  ${{ secrets.ADMIN_ALERT_CHAT_ID }}
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" \
            -d text="❌ Daily report не собрался (см. Actions)" \
            -d disable_web_page_preview=true >/dev/null
