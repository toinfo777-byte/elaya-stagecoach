name: Daily status report

on:
  schedule:
    # 09:00 MSK == 06:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch:
  repository_dispatch:
    types: [daily_report]

permissions:
  contents: write

concurrency:
  group: daily-report
  cancel-in-progress: false

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install python-dotenv==1.0.1

      - name: Compute meta
        id: meta
        run: |
          TS_UTC="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          TODAY="$(date -u +'%Y-%m-%d')"
          echo "ts_utc=${TS_UTC}" >> $GITHUB_OUTPUT
          echo "today=${TODAY}" >> $GITHUB_OUTPUT

      - name: Generate report md
        env:
          ENV: develop
          REPO: ${{ github.repository }}
          SHA:  ${{ github.sha }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          IMAGE_TAG: ghcr.io/${{ github.repository_owner }}/elaya-stagecoach:develop
          BUILD_MARK: daily-${{ steps.meta.outputs.today }}
          CRON_TS: ${{ steps.meta.outputs.ts_utc }}
        run: |
          python tools/daily_report.py

      - name: Commit report
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "report(daily): ${{ steps.meta.outputs.today }} [skip ci]"
          branch: main
          file_pattern: docs/elaya_status/*.md

      - name: Notify Telegram (success)
        if: ${{ success() }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CHAT:  ${{ secrets.ADMIN_ALERT_CHAT_ID }}
          FILEPATH: docs/elaya_status/Elaya_Status_${{ steps.meta.outputs.today }}.md
          RUN_URL:  ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TEXT="ðŸ§¾ Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð³Ð¾Ñ‚Ð¾Ð²\n${FILEPATH}\n\nCI: ${RUN_URL}"
          curl -sS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" -d text="$TEXT" -d disable_web_page_preview=true >/dev/null

      - name: Notify Telegram (failure)
        if: ${{ failure() }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CHAT:  ${{ secrets.ADMIN_ALERT_CHAT_ID }}
          RUN_URL:  ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TEXT="âŒ Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ Ð½Ðµ ÑÐ¾Ð±Ñ€Ð°Ð»ÑÑ\nCI: ${RUN_URL}"
          curl -sS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" -d text="$TEXT" -d disable_web_page_preview=true >/dev/null

      - name: Ping Cronitor
        if: ${{ always() }}
        env:
          CRONITOR_PING_URL: ${{ secrets.CRONITOR_DAILY_PING_URL }}
        run: |
          if [ -n "$CRONITOR_PING_URL" ]; then
            curl -fsS "$CRONITOR_PING_URL" || true
          fi
