name: Daily status report

on:
  schedule:
    - cron: "0 6 * * *"   # 06:00 UTC = 09:00 MSK
  workflow_dispatch:

permissions:
  contents: write
  packages: read

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          sudo apt-get update -yq
          sudo apt-get install -yq wkhtmltopdf
          pip install pypandoc

      - name: Build markdown
        run: |
          mkdir -p docs/elaya_status
          DATE=$(date -u +%Y%m%d)
          TS=$(date -u +"%Y-%m-%d %H:%M:%SZ")
          MD=docs/elaya_status/Elaya_Status_${DATE}.md
          echo "# Ежедневный отчёт" > "$MD"
          echo "- Time (UTC): ${TS}" >> "$MD"
          echo "- Branch: ${GITHUB_REF_NAME}" >> "$MD"
          echo "- Commit: ${GITHUB_SHA}" >> "$MD"
          echo "- Runner: ${GITHUB_RUN_ID}" >> "$MD"
          echo "" >> "$MD"
          echo "## Пульс" >> "$MD"
          echo "- ENV: develop" >> "$MD"
          echo "- Source: GitHub Actions" >> "$MD"
          echo "- Notes: Автогенерация." >> "$MD"

      - name: Build PDF
        run: |
          python - <<'PY'
          import pypandoc, datetime, os
          d = datetime.datetime.utcnow().strftime("%Y%m%d")
          md = f"docs/elaya_status/Elaya_Status_{d}.md"
          pdf = md.replace(".md", ".pdf")
          pypandoc.convert_text(open(md).read(), "pdf", format="md",
                                outputfile=pdf, extra_args=['--standalone'])
          print("✅ PDF создан:", pdf)
          PY

      - name: Commit & push
        run: |
          DATE=$(date -u +%Y%m%d)
          git config user.name "elaya-bot"
          git config user.email "actions@users.noreply.github.com"
          git add docs/elaya_status/Elaya_Status_${DATE}.*
          git commit -m "Daily report ${DATE}" || echo "No changes"
          git push

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: elaya-daily
          path: docs/elaya_status
