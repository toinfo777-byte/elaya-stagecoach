name: Daily Elaya Report

on:
  schedule:
    # 09:00 Europe/Moscow == 06:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  report:
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.commit.outputs.changes_detected }}
    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: python -m pip install --upgrade pip

      - name: Generate report
        env:
          RUN_URL: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        run: python tools/daily_report.py

      - name: Commit report
        id: commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "report: daily status [skip ci]"
          branch: develop
          file_pattern: docs/elaya_status/*.md

      - name: Notify Telegram (report ready)
        if: ${{ steps.commit.outputs.changes_detected == 'true' }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CHAT:  ${{ secrets.ADMIN_ALERT_CHAT_ID }}
          RUN_URL:  ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          TODAY="$(date -u +'%Y-%m-%d')"
          FILE="docs/elaya_status/Elaya_Status_${TODAY}.md"
          TEXT="üóì –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç –≠–ª–∞–π–∏ –≥–æ—Ç–æ–≤\n–§–∞–π–ª: ${FILE}\nCI: ${RUN_URL}"
          curl -sS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" \
            -d text="$TEXT" \
            -d disable_web_page_preview=true >/dev/null

  pr-to-main:
    needs: report
    if: ${{ needs.report.outputs.changed == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop

      - name: Create PR ‚Üí main
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: main
          branch: develop
          title: "chore(report): daily status ‚Üí main"
          body: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç. –ê–≤—Ç–æ—Å–ª–∏—è–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ."
          labels: |
            auto-merge
            daily-report

      - name: Enable automerge (squash)
        if: ${{ steps.cpr.outputs.pull-request-number }}
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
