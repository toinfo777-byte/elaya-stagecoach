name: Daily status report

on:
  schedule:
    - cron: "0 6 * * *"   # 06:00 UTC = 09:00 MSK
  workflow_dispatch:

permissions:
  contents: write
  packages: read

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          sudo apt-get update -yq
          sudo apt-get install -yq pandoc wkhtmltopdf
          pip install pypandoc

      - name: Build markdown
        run: |
          mkdir -p docs/elaya_status
          DATE=$(date -u +%Y%m%d)
          TS=$(date -u +"%Y-%m-%d %H:%M:%SZ")
          MD=docs/elaya_status/Elaya_Status_${DATE}.md
          echo "# –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –æ—Ç—á—ë—Ç" > "$MD"
          echo "- Time (UTC): ${TS}" >> "$MD"
          echo "- Branch: ${GITHUB_REF_NAME}" >> "$MD"
          echo "- Commit: ${GITHUB_SHA}" >> "$MD"
          echo "- Runner: ${GITHUB_RUN_ID}" >> "$MD"
          echo "" >> "$MD"
          echo "## –ü—É–ª—å—Å" >> "$MD"
          echo "- ENV: develop" >> "$MD"
          echo "- Source: GitHub Actions" >> "$MD"
          echo "- Notes: –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è." >> "$MD"

      - name: Build PDF (safe mode)
        run: |
          DATE=$(date -u +%Y%m%d)
          MD=docs/elaya_status/Elaya_Status_${DATE}.md
          PDF=${MD%.md}.pdf
          echo "üõ† –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–±—Ä–∞—Ç—å PDF —á–µ—Ä–µ–∑ pypandoc..."
          python - <<'PY'
          import pypandoc, datetime, os, sys
          d = datetime.datetime.utcnow().strftime("%Y%m%d")
          md = f"docs/elaya_status/Elaya_Status_{d}.md"
          pdf = md.replace(".md", ".pdf")
          try:
              pypandoc.convert_file(md, "pdf", outputfile=pdf, extra_args=["--pdf-engine=wkhtmltopdf", "--standalone"])
              print("‚úÖ PDF —Å–æ–∑–¥–∞–Ω:", pdf)
          except Exception as e:
              print("‚ö†Ô∏è –û—à–∏–±–∫–∞ —á–µ—Ä–µ–∑ pypandoc, –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ pandoc CLI:", e)
              os.system(f"pandoc {md} -o {pdf} --pdf-engine=wkhtmltopdf")
          if not os.path.exists(pdf):
              print("‚ùå PDF –Ω–µ —Å–æ–∑–¥–∞–Ω!")
              sys.exit(1)
          PY

      - name: Commit & push
        run: |
          DATE=$(date -u +%Y%m%d)
          git config user.name "elaya-bot"
          git config user.email "actions@users.noreply.github.com"
          git add docs/elaya_status/Elaya_Status_${DATE}.*
          git commit -m "Daily report ${DATE}" || echo "No changes"
          git push

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: elaya-daily
          path: docs/elaya_status
