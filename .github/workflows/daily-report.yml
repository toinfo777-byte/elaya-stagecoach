name: Daily status report

on:
  schedule:
    - cron: "0 6 * * *"   # 06:00 UTC = 09:00 MSK
  workflow_dispatch:

permissions:
  contents: write
  packages: read

jobs:
  report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: apt update
        run: 'sudo apt-get update'

      - name: Install pandoc + LaTeX
        run: 'sudo apt-get install -y pandoc texlive-latex-recommended texlive-fonts-recommended texlive-latex-extra'

      - name: Build markdown
        run: 'mkdir -p docs/elaya_status && DATE=$(date -u +%Y%m%d) && TS=$(date -u +"%Y-%m-%d %H:%M:%SZ") && MD=docs/elaya_status/Elaya_Status_${DATE}.md && printf "%s\n" "# Ежедневный отчёт" "- Time (UTC): ${TS}" "- Branch: ${GITHUB_REF_NAME}" "- Commit: ${GITHUB_SHA}" "- Runner: ${GITHUB_RUN_ID}" "" "## Пульс" "- ENV: develop" "- Source: GitHub Actions" "- Notes: Автогенерация." > "$MD"'

      - name: Build PDF
        run: 'DATE=$(date -u +%Y%m%d) && MD=docs/elaya_status/Elaya_Status_${DATE}.md && PDF=${MD%.md}.pdf && pandoc "$MD" -o "$PDF" -V geometry:margin=2cm -V mainfont="DejaVu Serif" --from gfm --pdf-engine=xelatex'

      - name: Commit & push
        run: 'DATE=$(date -u +%Y%m%d) && MD=docs/elaya_status/Elaya_Status_${DATE}.md && PDF=${MD%.md}.pdf && git config user.name "elaya-bot" && git config user.email "actions@users.noreply.github.com" && git add "$MD" "$PDF" && git commit -m "Daily report ${DATE}" || echo "No changes" && git push'

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: elaya-daily
          path: docs/elaya_status
