name: Daily status report

on:
  schedule:
    # 09:00 MSK = 06:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: daily-report
  cancel-in-progress: false

jobs:
  report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout develop
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install markdown-it-py==3.0.0

      - name: Generate daily markdown
        env:
          # Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶ÐµÐ½ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ñ‚Ð¾ÐºÐµÐ½Ð°Ð¼ (Ð½Ðµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾)
          # TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          # ADMIN_ALERT_CHAT_ID: ${{ secrets.ADMIN_ALERT_CHAT_ID }}
          TZ: Europe/Moscow
        run: |
          python tools/daily_report.py  # Ñ„Ð°Ð¹Ð» ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ñƒ Ð½Ð°Ñ
          ls -la docs/elaya_status || true

      - name: Commit report to develop
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore(report): daily Elaya status [skip ci]"
          branch: develop
          file_pattern: docs/elaya_status/*.md

      - name: Notify Telegram (success)
        if: ${{ success() }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CHAT:  ${{ secrets.ADMIN_ALERT_CHAT_ID }}
        run: |
          TODAY="$(date -u +'%Y-%m-%d')"
          FILE="docs/elaya_status/Elaya_Status_${TODAY}.md"
          TEXT="ðŸ—“ Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚ ÑÐ¾Ð±Ñ€Ð°Ð½\nÐ¤Ð°Ð¹Ð»: ${FILE}\nÐ’ÐµÑ‚ÐºÐ°: develop"
          curl -sS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" -d text="$TEXT" -d disable_web_page_preview=true >/dev/null

      - name: Notify Telegram (failure)
        if: ${{ failure() }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TG_CHAT:  ${{ secrets.ADMIN_ALERT_CHAT_ID }}
        run: |
          curl -sS -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" \
            -d text="âŒ Daily report Ð½Ðµ ÑÐ¾Ð±Ñ€Ð°Ð»ÑÑ (ÑÐ¼. Actions)" \
            -d disable_web_page_preview=true >/dev/null
