<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Элайя — StageCoach</title>
  <link rel="stylesheet" href="/static/theme.css" />
</head>
<body>
  <main class="wrap">
    <header class="hdr">
      <h1>Элайя — <span>StageCoach</span> <b class="dot"></b></h1>
      <p class="subtitle">панель наблюдения</p>
    </header>

    <section class="grid">
      <div class="card">
        <h3>Портал</h3>
        <div class="chips">
          <span class="chip">Stable</span>
          <span class="chip">Online</span>
          <span class="chip">Light active</span>
        </div>
        <div class="badges">
          <span class="badge">• HQ Panel</span>
          <span class="badge badge-on">• Cycle Active</span>
          <span class="badge">• Memory Stable</span>
          <span class="badge">• Reflection On</span>
          <button id="open-reflection" class="btn-inline">Добавить заметку</button>
        </div>
      </div>

      <div class="card">
        <h3>Последняя заметка · reflection</h3>
        <div id="reflection-text" class="block">—</div>
        <div class="meta">
          <b class="mini-dot"></b>
          <span id="reflection-time">—</span>
        </div>
      </div>

      <div class="card wide">
        <h3>Core · состояние</h3>
        <p class="muted">Последнее обновление ядра: <span id="core-upd">—</span></p>
        <div class="chips" id="core-counters">
          <span class="chip">intro: <span id="c-intro">0</span></span>
          <span class="chip">reflect: <span id="c-reflect">0</span></span>
          <span class="chip">transition: <span id="c-transition">0</span></span>
        </div>
        <div class="badges">
          <span class="badge">• HQ Panel</span>
          <span class="badge badge-on">• Cycle Active</span>
          <span class="badge">• Memory Stable</span>
          <span class="badge">• Reflection On</span>
        </div>
      </div>
    </section>
  </main>

  <!-- модалка для добавления заметки -->
  <dialog id="dlg">
    <form id="reflection-form" method="dialog">
      <h4>Новая заметка</h4>
      <textarea name="text" rows="6" placeholder="Текст заметки…"></textarea>
      <div class="dlg-actions">
        <button type="submit" class="btn">Сохранить</button>
        <button type="button" id="dlg-close" class="btn ghost">Отмена</button>
      </div>
    </form>
  </dialog>

  <!-- JS: автообновление + submit -->
  <script>
    const $ = (q) => document.querySelector(q);

    async function loadStats() {
      try {
        const r = await fetch("/ui/stats.json", { cache: "no-store" });
        const data = await r.json();

        $("#reflection-text").textContent = data.reflection.text || "—";
        $("#reflection-time").textContent = data.reflection.updated_at || "—";

        $("#core-upd").textContent = data.core.last_updated || "—";
        $("#c-intro").textContent = data.core.intro ?? 0;
        $("#c-reflect").textContent = data.core.reflect ?? 0;
        $("#c-transition").textContent = data.core.transition ?? 0;
      } catch (e) {
        console.error(e);
      }
    }

    // автообновление панели
    loadStats();
    setInterval(loadStats, 5000);

    // модалка
    const dlg = $("#dlg");
    $("#open-reflection").addEventListener("click", () => dlg.showModal());
    $("#dlg-close").addEventListener("click", () => dlg.close());

    // отправка заметки
    $("#reflection-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const r = await fetch("/ui/reflection", { method: "POST", body: fd });
      if (r.ok) {
        dlg.close();
        e.target.reset();
        loadStats();
      }
    });
  </script>
</body>
</html>
